# Next.js Slack風チャットアプリケーション開発計画

## 1. プロジェクト概要

*   **目的**: Next.js (App Router) とNode.js (Socket.io) を用いたSlack風チャットアプリケーションの技術探求。
*   **想定規模**: 中規模 (30〜50ユーザー、1時間あたり10000文字程度の利用)。
*   **デプロイ環境**: 自社サーバーのminikube上にDockerコンテナとしてデプロイ。
*   **開発期間**: 〜2025年3月末。
*   **データベース**: MongoDB。
*   **認証**: ユーザーID/パスワード (JWTを利用)。
*   **リアルタイム通信**: Node.js + Socket.ioサーバー。
*   **設計原則**: DAO/Repositoryパターンによるアプリケーション層とデータベース層の分離、ゼロトラストの思想の導入。
*   **将来的な機能**: PWA通知。

## 2. 必須機能

1.  **ログイン**: ユーザーID/パスワードによる認証。
2.  **チャンネルでのチャット**: 複数のチャンネルでのメッセージ送受信。
3.  **データの永続化**: メッセージ、ユーザー、チャンネル、スレッド情報のデータベース保存。
4.  **会話のスレッド化**: メッセージに対する返信機能。

## 3. アーキテクチャ概要

*   **フロントエンド**: Next.js (App Router)
    *   クライアントコンポーネントでSocket.ioクライアントライブラリを使用してリアルタイム通信。
    *   ログイン、チャットUI、スレッド表示などを実装。
    *   認証情報の管理（JWTをHTTP Only Cookieで保存）。
    *   **将来的なPWA通知**: Service WorkerとPush APIの統合を考慮した設計。
*   **バックエンド (API)**: Next.js Route Handlers
    *   ユーザー認証（ログイン）API。
    *   メッセージ履歴の取得、チャンネル情報取得など、リアルタイムではないデータ取得API。
    *   **DAO/Repositoryパターン**: データベース操作を抽象化し、Next.js Route Handlersから利用。
    *   Socket.ioサーバーへのイベントトリガー（必要であれば）。
    *   **ゼロトラスト**: すべてのAPIリクエストでJWTを検証し、認可を行う。
    *   **将来的なPWA通知**: Push通知の購読管理や、通知ペイロードの送信を処理するAPI。
*   **バックエンド (リアルタイム)**: Node.js + Socket.ioサーバー
    *   独立したDockerコンテナとして稼働。
    *   クライアントからのWebSocket接続を処理。
    *   ユーザーがログイン後、Socket.ioサーバーに接続し、認証情報（JWT）を検証。
    *   メッセージの送受信、オンライン状態の管理、ルーム（チャンネル）管理。
    *   **DAO/Repositoryパターン**: データベース操作を抽象化し、Socket.ioサーバーから利用。
    *   **ゼロトラスト**: すべてのSocket.io接続およびイベントでJWTを検証し、認可を行う。
    *   **将来的なPWA通知**: 新しいメッセージが来た際に、Next.js Route Handlers経由でPush通知をトリガーする。
*   **データベース**: MongoDB
    *   ユーザー情報、チャンネル情報、メッセージ、スレッド情報を格納。
    *   **ゼロトラスト**: データベースへのアクセスは、Next.js Route HandlersおよびNode.js Socket.ioサーバーからのみ許可し、最小権限のユーザーを使用。
    *   **将来的なPWA通知**: Push通知の購読情報（Subscription Object）を保存。
*   **デプロイ環境**: minikube上のDockerコンテナ
    *   **ゼロトラスト**: Kubernetes NetworkPolicyを使用して、各コンテナ間の通信を厳密に制御。

## 4. 開発計画 (ベイビーステップ)

### フェーズ1: 基本的な環境構築とログイン機能 (〜1月末)

1.  **プロジェクト初期設定**:
    *   Next.jsプロジェクトの作成 (App Router)。
    *   Node.js + Express + Socket.ioサーバープロジェクトの作成。
    *   Docker Composeファイルを作成し、Next.js、Node.js Socket.ioサーバー、MongoDBを連携させる。
    *   minikubeへのデプロイ設定（Kubernetesマニフェストの準備）。
2.  **データベース設定**:
    *   MongoDBのスキーマ設計（ユーザー、チャンネル、メッセージ、スレッド）。
    *   初期データの投入（ユーザー、チャンネル）。
    *   **DAO/Repositoryパターン**: MongoDB操作のためのDAO/Repositoryインターフェースと実装を定義。
3.  **認証バックエンド**:
    *   Node.jsサーバーにログインAPIを実装。
    *   **DAO/Repositoryパターン**: ユーザー情報の取得にRepositoryを使用。
    *   JWTトークンを発行し、クライアントに返す。
    *   パスワードのハッシュ化（bcryptなど）。
    *   **ゼロトラスト**: ログインAPIへのアクセスレート制限などを検討。
4.  **認証フロントエンド**:
    *   Next.jsでログインページを作成。
    *   ユーザーID/パスワードを入力し、バックエンドAPIに送信。
    *   受け取ったJWTトークンをHTTP Only Cookieで安全に保存。
    *   認証済みユーザーのみがチャットページにアクセスできるようにルーティングガードを実装。

### フェーズ2: チャンネルチャットとデータの永続化 (〜2月末)

1.  **Socket.ioサーバー**:
    *   Node.js Socket.ioサーバーで、クライアントからの接続、切断を処理。
    *   **ゼロトラスト**: ユーザーがログイン後、Socket.ioサーバーに接続する際に、JWTを検証し、認証・認可を行うミドルウェアを実装。
    *   チャンネル（ルーム）への参加/退出機能を実装。
    *   メッセージ受信イベントを処理し、**DAO/Repositoryパターン** を使用してデータベースにメッセージを永続化。
    *   メッセージ送信イベントを、同じチャンネルの全クライアントにブロードキャスト。
    *   **ゼロトラスト**: メッセージ送信時にも、送信ユーザーがそのチャンネルにメッセージを送信する権限があるか検証。
2.  **チャットUI**:
    *   Next.jsでチャットページを作成。
    *   チャンネルリストを表示し、チャンネル選択機能を実装。
    *   選択したチャンネルのメッセージ履歴をNext.js Route Handlers経由で取得し表示。
    *   メッセージ入力フォームと送信ボタン。
    *   Socket.ioクライアントを使用して、リアルタイムでメッセージを受信し表示。
3.  **オンライン状態表示**:
    *   Socket.ioサーバーで、ユーザーの接続/切断時にオンライン状態を管理し、他のクライアントに通知。
    *   チャットUIで、チャンネル内のオンラインユーザーリストを表示。

### フェーズ3: 会話のスレッド化 (〜3月末)

1.  **データベーススキーマ拡張**:
    *   メッセージコレクションに`parentId`などのフィールドを追加し、スレッドの親子関係を表現できるようにする。
2.  **Socket.ioサーバー拡張**:
    *   メッセージ送信時に、親メッセージIDを含めることができるようにする。
    *   スレッドへの返信を処理し、関連するクライアントに通知。
    *   **DAO/Repositoryパターン**: スレッド関連のデータベース操作をRepositoryに追加。
3.  **チャットUI拡張**:
    *   メッセージ表示時に、スレッドの親メッセージと子メッセージを視覚的に区別して表示。
    *   メッセージに対して返信する機能（スレッドを開始/参加）。
    *   スレッドビューの表示/非表示機能。

## 5. 将来的な機能 (PWA通知)

*   Next.jsプロジェクトに`next-pwa`などのライブラリを導入し、Service Workerを登録。
*   クライアントサイドでPush通知の購読を要求し、取得したSubscription Objectをデータベースに保存するAPIを実装。
*   Socket.ioサーバーで新しいメッセージが来た際に、購読情報に基づいてPush通知を送信するロジックを実装。
